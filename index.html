<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th∆∞ vi·ªán Qu·∫£n tr·ªã R·ªßi ro</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Dark Theme (Default) */
      --bg-color: #0a0e27;
      --sidebar-bg: #151937;
      --card-bg: rgba(255, 255, 255, 0.03);
      --card-hover: rgba(255, 255, 255, 0.06);
      --text-color: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --border-color: rgba(255, 255, 255, 0.15);
      --accent-color: #667eea;
      --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --header-bg: rgba(15, 20, 35, 0.7);
      --header-bg: rgba(15, 20, 35, 0.7);
      --popup-bg: rgba(15, 20, 35, 0.95);
      --hero-bg: radial-gradient(circle at 10% 20%, rgba(100, 100, 255, 0.1) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(100, 100, 255, 0.05) 0%, transparent 20%);
    }

    [data-theme="summer"] {
      /* Summer Theme (Beach vibes) */
      --bg-color: #0a1628;
      --sidebar-bg: #1a2942;
      --card-bg: rgba(100, 200, 255, 0.05);
      --card-hover: rgba(100, 200, 255, 0.1);
      --text-color: #e8f4f8;
      --text-muted: rgba(232, 244, 248, 0.7);
      --border-color: rgba(100, 200, 255, 0.2);
      --accent-color: #00BFFF;
      --accent-gradient: linear-gradient(135deg, #00BFFF 0%, #1E90FF 100%);
      --header-bg: rgba(10, 22, 40, 0.9);
      --popup-bg: rgba(10, 22, 40, 0.95);
      --hero-bg: linear-gradient(135deg, #1E90FF 0%, #00CED1 50%, #FFD700 100%);
    }

    [data-theme="tet"] {
      /* Tet Theme (Red/Gold) */
      --bg-color: #3e0000;
      --sidebar-bg: #5a0000;
      --card-bg: rgba(255, 215, 0, 0.05);
      --card-hover: rgba(255, 215, 0, 0.1);
      --text-color: #fff8e1;
      --text-muted: rgba(255, 248, 225, 0.7);
      --border-color: rgba(255, 215, 0, 0.3);
      --accent-color: #FFD700;
      --accent-gradient: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      --header-bg: rgba(62, 0, 0, 0.9);
      --header-bg: rgba(62, 0, 0, 0.9);
      --popup-bg: rgba(62, 0, 0, 0.95);
      --hero-bg: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 60%), linear-gradient(135deg, #5a0000 0%, #3e0000 100%);
    }

    [data-theme="spring"] {
      /* Spring Theme (Pink/Green) */
      --bg-color: #1a0f1f;
      --sidebar-bg: #2d1b36;
      --card-bg: rgba(255, 182, 193, 0.05);
      --card-hover: rgba(255, 182, 193, 0.1);
      --text-color: #fff0f5;
      --text-muted: rgba(255, 240, 245, 0.7);
      --border-color: rgba(255, 105, 180, 0.3);
      --accent-color: #FF69B4;
      --accent-gradient: linear-gradient(135deg, #FF69B4 0%, #00FF7F 100%);
      --header-bg: rgba(26, 15, 31, 0.9);
      --header-bg: rgba(26, 15, 31, 0.9);
      --popup-bg: rgba(26, 15, 31, 0.95);
      --hero-bg: radial-gradient(circle at 50% 50%, rgba(255, 105, 180, 0.2) 0%, transparent 50%), linear-gradient(to right, #2d1b36, #1a0f1f);
    }

    [data-theme="autumn"] {
      /* Autumn Theme (Orange/Brown) */
      --bg-color: #2b1100;
      --sidebar-bg: #3e1b00;
      --card-bg: rgba(255, 165, 0, 0.05);
      --card-hover: rgba(255, 165, 0, 0.1);
      --text-color: #fff3e0;
      --text-muted: rgba(255, 243, 224, 0.7);
      --border-color: rgba(255, 140, 0, 0.3);
      --accent-color: #FF8C00;
      --accent-gradient: linear-gradient(135deg, #FF8C00 0%, #D2691E 100%);
      --header-bg: rgba(43, 17, 0, 0.9);
      --header-bg: rgba(43, 17, 0, 0.9);
      --popup-bg: rgba(43, 17, 0, 0.95);
      --hero-bg: linear-gradient(to right, #3e1b00, #2b1100);
    }

    [data-theme="winter"] {
      /* Winter Theme (White/Ice Blue) */
      --bg-color: #0d1b2a;
      --sidebar-bg: #1b263b;
      --card-bg: rgba(0, 255, 255, 0.05);
      --card-hover: rgba(0, 255, 255, 0.1);
      --text-color: #e0faff;
      --text-muted: rgba(224, 250, 255, 0.7);
      --border-color: rgba(0, 255, 255, 0.3);
      --accent-color: #00FFFF;
      --accent-gradient: linear-gradient(135deg, #00FFFF 0%, #7FFFD4 100%);
      --header-bg: rgba(13, 27, 42, 0.9);
      --header-bg: rgba(13, 27, 42, 0.9);
      --popup-bg: rgba(13, 27, 42, 0.95);
      --hero-bg: radial-gradient(circle at top right, rgba(255, 255, 255, 0.1), transparent), linear-gradient(to bottom, #1b263b, #0d1b2a);
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      overflow-x: hidden;
      /* Prevent horizontal scroll only */
      min-height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    /* Header (Title Block) - Now in Sidebar */
    .header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    /* Global Layout Borders */
    #home-section,
    #report-section {
      max-width: 1400px;
      /* Constrain width */
      margin: 0 auto;
      border-right: 1px solid var(--border-color);
      border-left: 1px solid var(--border-color);
    }

    .header-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .header-subtitle {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: -2px;
    }

    /* Sidebar */
    .sidebar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: var(--sidebar-bg);
      z-index: 999;
      overflow-y: auto;
      padding: 20px;
      padding-top: 150px;
      /* Increased to avoid Header overlap */
      border-right: 1px solid var(--border-color);
      transition: background 0.3s;
    }

    .sidebar-section {
      margin-bottom: 28px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .filter-option {
      padding: 10px 14px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-color);
    }

    .filter-option:hover {
      background: var(--card-hover);
      border-color: var(--accent-color);
    }

    .filter-option.active {
      background: rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }

    .filter-radio {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      position: relative;
    }

    .filter-option.active .filter-radio::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
    }

    .filter-label {
      font-size: 13px;
      font-weight: 500;
    }

    /* Stats Cards */
    .stat-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .stat-icon.stores {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-icon.violations {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-icon.rewards {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-content {
      flex: 1;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
    }

    /* Risk Gradient */
    .risk-gradient {
      height: 8px;
      background: linear-gradient(90deg, #00ff88 0%, #ffeb3b 25%, #ff9800 50%, #f44336 100%);
      border-radius: 4px;
      margin-top: 8px;
    }

    .risk-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* Map */
    #map {
      position: absolute;
      left: 280px;
      top: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-color);
    }

    .leaflet-container {
      background: var(--bg-color) !important;
    }

    /* Numbered Markers */
    .marker-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      color: #000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .marker-green {
      background: #00ff88;
    }

    .marker-yellow {
      background: #ffeb3b;
    }

    .marker-orange {
      background: #ff9800;
    }

    .marker-red {
      background: #f44336;
      color: #fff;
    }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: #0a0e27;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    /* Login Screen */
    #login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-box {
      background: #fff;
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-box h2 {
      color: #667eea;
      margin-bottom: 8px;
      font-size: 24px;
    }

    .login-box p {
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .login-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    .login-input:focus {
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      color: #f44336;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    /* Map Sovereignty Labels */
    .map-label {
      font-size: 14px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
      white-space: nowrap;
      pointer-events: none !important;
    }

    /* Store Names on Zoom */
    .store-label-tooltip {
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
      color: #fff !important;
      font-weight: 600;
      font-weight: 600;
      font-size: 12px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.6);
      /* Reduced shadow strength */
      margin-top: -45px !important;
      opacity: 0 !important;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .show-names .store-label-tooltip {
      opacity: 1 !important;
      visibility: visible;
    }

    /* Custom Popup -> Right Sidebar */
    .popup-overlay {
      display: none !important;
    }

    #custom-popup {
      position: absolute;
      /* Changed to absolute to stay inside map section */
      top: 0;
      right: 0;
      bottom: 0;
      width: 400px;
      max-width: 100%;
      background: var(--popup-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-color);
      z-index: 9999;
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0.0, 0.2, 1);
      box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: var(--text-color);
    }

    #custom-popup.open {
      transform: translateX(0);
    }

    /* View Container for Sliding */
    #popup-views {
      position: relative;
      flex: 1;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .view-section {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      background: transparent;
    }

    /* List View (Default) */
    #view-list {
      z-index: 1;
      transform: translateX(0);
    }

    /* Detail View (Slides in) */
    #view-detail {
      z-index: 2;
      transform: translateX(100%);
      background: rgba(15, 20, 35, 0.95);
      /* Ensure opacity over list */
    }

    /* Animation State: Showing Details */
    #custom-popup.show-detail #view-list {
      transform: translateX(-30%);
      /* Parallax effect */
      opacity: 0;
    }

    #custom-popup.show-detail #view-detail {
      transform: translateX(0);
    }

    /* Headers */
    .popup-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      position: relative;
      flex-shrink: 0;
    }

    .popup-header h3 {
      font-size: 18px;
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .popup-header .address {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.5;
    }

    .popup-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .popup-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      margin-bottom: 12px;
      transition: color 0.2s;
      background: none;
      border: none;
      padding: 0;
    }

    .back-btn:hover {
      color: #fff;
    }

    .popup-tabs {
      display: flex;
      gap: 12px;
      padding: 0 24px;
      margin-top: 16px;
    }

    .popup-tab {
      padding: 10px 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
      white-space: nowrap;
      color: var(--text-color);
    }

    .popup-tab.active {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .popup-tab.violations.active {
      background: rgba(244, 67, 54, 0.15);
      border-color: rgba(244, 67, 54, 0.4);
      color: #ffa4a2;
    }

    .popup-tab.rewards.active {
      background: rgba(0, 255, 136, 0.15);
      border-color: rgba(0, 255, 136, 0.4);
      color: #69f0ae;
    }

    .popup-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .item-card {
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .item-card:hover {
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .item-card .item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 6px;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .item-card .item-date {
      font-weight: 400;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
    }

    .item-card .item-preview {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.5;
      display: -webkit-box;
      /* Standard property for compatibility */
      line-clamp: 2;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Detail View Styling */
    .detail-body {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .detail-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
      line-height: 1.5;
      color: var(--text-color);
      border-left: 3px solid #f44336;
      padding-left: 12px;
    }

    .detail-field {
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      padding-bottom: 16px;
    }

    .detail-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 8px;
    }

    .detail-value {
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
      white-space: pre-wrap;
      /* Preserve line breaks */
    }

    /* Search Box */
    .sidebar-search {
      margin-bottom: 24px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-color);
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: rgba(15, 20, 35, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      margin-top: 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1001;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .search-results.active {
      display: block;
    }

    .search-item {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      transition: background 0.2s;
    }

    .search-item:last-child {
      border-bottom: none;
    }

    .search-item:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    .search-item .sub-text {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 2px;
    }

    /* News Ticker */
    #news-ticker {
      position: absolute;
      /* Changed from fixed to absolute */
      top: 0;
      left: 280px;
      /* Sidebar width */
      right: 240px;
      /* OM Stats width + padding */
      height: 40px;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      z-index: 998;
      display: flex;
      align-items: center;
      overflow: hidden;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
    }

    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: marquee 60s linear infinite;
      /* Slowed down from 30s */
    }

    .ticker-content:hover {
      animation-play-state: paused;
    }

    .ticker-item {
      display: inline-block;
      padding: 0 20px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.9);
      cursor: pointer;
    }

    .ticker-item .highlight {
      color: #f44336;
      font-weight: 700;
      margin-right: 5px;
    }

    .ticker-item .date {
      color: rgba(255, 255, 255, 0.5);
      margin-right: 5px;
      font-size: 11px;
    }

    @keyframes marquee {
      0% {
        transform: translate(0, 0);
      }

      100% {
        transform: translate(-100%, 0);
      }
    }

    /* OM Stats Sidebar (Right) */
    #om-stats {
      position: absolute;
      /* Changed from fixed to absolute */
      top: 20px;
      right: 20px;
      width: 220px;
      background: rgba(15, 20, 35, 0.8);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 16px;
      z-index: 1000;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .om-title {
      font-size: 12px;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.5);
      text-transform: uppercase;
      margin-bottom: 12px;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding-bottom: 8px;
    }

    .om-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      font-size: 13px;
    }

    .om-item:last-child {
      border-bottom: none;
    }

    .om-name {
      color: rgba(255, 255, 255, 0.9);
      font-weight: 500;
    }

    .om-count {
      background: rgba(244, 67, 54, 0.2);
      color: #ff8a80;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }

    /* --- PORTAL STYLES --- */
    /* Navigation */
    .nav-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      /* background: rgba(15, 20, 35, 0.95); */
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      /* border-bottom: 1px solid rgba(255, 255, 255, 0.1); */
      border-bottom: 1px solid var(--border-color);
      z-index: 9999;
      display: flex;
      align-items: center;
      padding: 0 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .nav-logo {
      height: 40px;
      margin-right: 40px;
    }

    .nav-items {
      display: flex;
      gap: 30px;
    }

    .nav-item {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      /* Anchors */
    }

    .nav-item:hover,
    .nav-item.active {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-item.active {
      color: #fcb900;
      /* Yody Yellow */
    }

    /* View Container (Reset) */
    .view-container {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      height: auto;
      display: block !important;
      opacity: 1 !important;
    }

    .view-container.active {
      display: block;
      opacity: 1;
    }

    /* Home Section Styles */
    #home-section {
      background: #0f1423;
      padding-top: 60px;
      min-height: 100vh;
    }

    .hero-section {
      position: relative;
      width: 100%;
      padding: 80px 40px;
      background: var(--hero-bg, linear-gradient(135deg, rgba(29, 39, 85, 0.8) 0%, rgba(15, 20, 35, 0.95) 100%));
      border-bottom: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      overflow: hidden;
      transition: background 0.5s ease;
    }

    /* Tet Theme Decorations */
    [data-theme="tet"] .hero-section::before {
      content: 'üßß';
      position: absolute;
      top: 20px;
      left: 30px;
      font-size: 60px;
      animation: float 3s ease-in-out infinite;
      opacity: 0.8;
    }

    [data-theme="tet"] .hero-section::after {
      content: 'üå∏üå∏üå∏';
      position: absolute;
      bottom: 30px;
      right: 40px;
      font-size: 40px;
      animation: float 4s ease-in-out infinite;
      animation-delay: 0.5s;
    }



    /* Spring Theme Decorations */
    [data-theme="spring"] .hero-section::before {
      content: 'üå∏';
      position: absolute;
      top: 15%;
      left: 10%;
      font-size: 80px;
      animation: spin-slow 20s linear infinite;
      opacity: 0.6;
    }

    [data-theme="spring"] .hero-section::after {
      content: 'ü¶ã';
      position: absolute;
      bottom: 20%;
      right: 15%;
      font-size: 50px;
      animation: flutter 4s ease-in-out infinite;
    }

    /* Summer Theme Decorations */
    [data-theme="summer"] .hero-section::before {
      content: '‚òÄÔ∏è';
      position: absolute;
      top: 20px;
      right: 40px;
      font-size: 70px;
      animation: pulse 2s ease-in-out infinite;
    }

    [data-theme="summer"] .hero-section::after {
      content: 'üåä';
      position: absolute;
      bottom: 30px;
      left: 50px;
      font-size: 50px;
      opacity: 0.7;
    }

    /* Autumn Theme Decorations */
    [data-theme="autumn"] .hero-section::before,
    [data-theme="autumn"] .hero-section::after {
      content: 'üçÇ';
      position: absolute;
      font-size: 60px;
      animation: fall 8s linear infinite;
    }

    [data-theme="autumn"] .hero-section::before {
      top: -50px;
      left: 20%;
    }

    [data-theme="autumn"] .hero-section::after {
      top: -50px;
      right: 30%;
      animation-delay: 2s;
      font-size: 50px;
    }

    /* Winter Theme Decorations */
    [data-theme="winter"] .hero-section::before,
    [data-theme="winter"] .hero-section::after {
      content: '‚ùÑÔ∏è';
      position: absolute;
      font-size: 40px;
      animation: snow 10s linear infinite;
      opacity: 0.8;
    }

    [data-theme="winter"] .hero-section::before {
      top: -20px;
      left: 15%;
    }

    [data-theme="winter"] .hero-section::after {
      top: -20px;
      right: 25%;
      animation-delay: 3s;
    }

    /* Animations */
    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    @keyframes spin-slow {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes flutter {

      0%,
      100% {
        transform: translate(0, 0);
      }

      25% {
        transform: translate(10px, -10px);
      }

      50% {
        transform: translate(-5px, -15px);
      }

      75% {
        transform: translate(5px, -5px);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    @keyframes fall {
      0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    @keyframes snow {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(100vh);
        opacity: 0;
      }
    }

    .hero-logo {
      height: 80px;
      margin-bottom: 24px;
    }

    .hero-text {
      max-width: 800px;
      color: #fff;
      line-height: 1.6;
      font-size: 16px;
      font-style: italic;
      background: rgba(0, 0, 0, 0.3);
      padding: 30px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(4px);
    }

    .wall-grid {
      max-width: 1200px;
      margin: 40px auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
      padding: 0 24px;
      position: relative;
    }

    /* News Grid Decorations */
    [data-theme="tet"] .wall-grid::before {
      content: 'üßß';
      position: absolute;
      top: -30px;
      right: 40px;
      font-size: 50px;
      animation: float 3s ease-in-out infinite;
      z-index: 1;
    }

    [data-theme="spring"] .wall-grid::before {
      content: 'üå∏';
      position: absolute;
      top: -20px;
      left: 30px;
      font-size: 60px;
      animation: spin-slow 20s linear infinite;
      opacity: 0.7;
    }

    [data-theme="summer"] .wall-grid::after {
      content: 'üå¥';
      position: absolute;
      top: -20px;
      right: 50px;
      font-size: 50px;
      animation: float 3s ease-in-out infinite;
    }

    [data-theme="autumn"] .wall-grid::before {
      content: 'üçÇ';
      position: absolute;
      top: -40px;
      left: 20%;
      font-size: 50px;
      animation: fall 8s linear infinite;
    }

    [data-theme="winter"] .wall-grid::before {
      content: '‚ùÑÔ∏è';
      position: absolute;
      top: -30px;
      right: 15%;
      font-size: 40px;
      animation: snow 10s linear infinite;
    }

    .news-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }

    .news-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.3);
    }

    .news-img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      background: #2a2a2a;
    }

    .news-content {
      padding: 20px;
    }

    .news-tag {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #fcb900;
      margin-bottom: 8px;
      display: block;
    }

    .news-title {
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .news-excerpt {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 16px;
      line-height: 1.5;
    }

    .news-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      border-top: 1px solid rgba(255, 255, 255, 0.05);
      padding-top: 12px;
    }

    .hero-btn {
      background: #fcb900;
      color: #000;
      font-weight: 700;
      padding: 12px 30px;
      border-radius: 30px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: transform 0.2s;
      text-decoration: none;
      display: inline-block;
      margin-top: 20px;
    }

    .hero-btn:hover {
      transform: scale(1.05);
    }

    /* Map Section Styles */
    /* Map Section Styles */
    #map-section {
      width: 100%;
      height: 120vh;
      /* Adjusted to 120% as requested */
      position: relative;
      border-top: 1px solid var(--border-color);

      /* Map Border Logic */
      max-width: 1400px;
      margin: 0 auto;
      border-right: 2px solid var(--border-color);
      /* Slightly thicker/visible as requested */
      border-left: 2px solid var(--border-color);
      border-bottom: 2px solid var(--border-color);
      box-sizing: border-box;

      /* FORCE DARK THEME VARIABLES WITHIN MAP (Ignore Global Theme) */
      --bg-color: #0a0e27;
      --sidebar-bg: #151937;
      --card-bg: rgba(255, 255, 255, 0.03);
      --card-hover: rgba(255, 255, 255, 0.06);
      --text-color: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.6);
      --border-color: rgba(255, 255, 255, 0.15);
      --accent-color: #667eea;
      --header-bg: rgba(15, 20, 35, 0.7);
      --popup-bg: rgba(15, 20, 35, 0.95);
    }

    #map-section .header {
      right: 20px;
      top: 20px;
    }

    /* Header inside map section */

    /* Report Section Styles */
    #report-section {
      background: var(--bg-color);
      padding: 80px 20px;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
      border-top: 1px solid var(--border-color);
      position: relative;
      overflow: hidden;
    }

    /* Report Section Decorations */
    [data-theme="tet"] #report-section::before {
      content: 'üßßüßß';
      position: absolute;
      bottom: 40px;
      left: 30px;
      font-size: 50px;
      animation: float 4s ease-in-out infinite;
      opacity: 0.6;
    }

    [data-theme="tet"] #report-section::after {
      content: 'üå∏';
      position: absolute;
      top: 40px;
      right: 50px;
      font-size: 60px;
      animation: float 3.5s ease-in-out infinite;
      animation-delay: 1s;
    }

    [data-theme="spring"] #report-section::before {
      content: 'ü¶ã';
      position: absolute;
      top: 50px;
      left: 40px;
      font-size: 50px;
      animation: flutter 4s ease-in-out infinite;
    }

    [data-theme="summer"] #report-section::before {
      content: 'üåä';
      position: absolute;
      bottom: 50px;
      right: 60px;
      font-size: 60px;
      opacity: 0.5;
    }

    [data-theme="autumn"] #report-section::before,
    [data-theme="autumn"] #report-section::after {
      content: 'üçÇ';
      position: absolute;
      font-size: 50px;
      animation: fall 10s linear infinite;
    }

    [data-theme="autumn"] #report-section::before {
      top: -30px;
      left: 25%;
    }

    [data-theme="autumn"] #report-section::after {
      top: -30px;
      right: 20%;
      animation-delay: 3s;
    }

    [data-theme="winter"] #report-section::before,
    [data-theme="winter"] #report-section::after {
      content: '‚ùÑÔ∏è';
      position: absolute;
      font-size: 45px;
      animation: snow 12s linear infinite;
      opacity: 0.7;
    }

    [data-theme="winter"] #report-section::before {
      top: -20px;
      left: 20%;
    }

    [data-theme="winter"] #report-section::after {
      top: -20px;
      right: 30%;
      animation-delay: 4s;
    }

    .report-box {
      width: 100%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 40px;
    }

    .report-title {
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #fff;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-textarea {
      height: 100px;
      resize: vertical;
    }

    .form-submit {
      width: 100%;
      background: #f44336;
      color: #fff;
      font-weight: 700;
      padding: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }

    .footer {
      width: 100%;
      text-align: center;
      padding: 40px;
      color: rgba(255, 255, 255, 0.3);
      font-size: 12px;
      background: #0a0e1a;
    }

    /* Borders Enhancement */
    .news-card,
    .report-box,
    .sidebar-section,
    .stat-card,
    .folder-item {
      border: 1px solid rgba(255, 255, 255, 0.2) !important;
      /* Visual containment */
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {

      /* Navigation */
      .nav-bar {
        padding: 0 16px;
        height: 54px;
      }

      .nav-logo {
        height: 28px;
        margin-right: 16px;
      }

      .nav-items {
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 0;
        mask-image: linear-gradient(90deg, #000 90%, transparent);
      }

      .nav-item {
        font-size: 13px;
        padding: 6px 10px;
        white-space: nowrap;
      }

      /* Home Section */
      #home-section {
        padding-top: 54px;
      }

      .hero-section {
        padding: 40px 20px;
        text-align: left;
      }

      .hero-text {
        font-size: 14px;
        padding: 20px;
      }

      .wall-grid {
        grid-template-columns: 1fr;
        /* Single column */
        gap: 16px;
        padding: 0 16px;
      }

      /* Map Section layout */
      .sidebar {
        transform: translateX(-100%);
        /* Hidden by default */
        top: 0;
        bottom: 0;
        width: 85%;
        box-shadow: 10px 0 50px rgba(0, 0, 0, 0.8);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10001;
        /* Above map UI */
      }

      .sidebar.open {
        transform: translateX(0);
      }

      #map {
        left: 0 !important;
        /* Full width */
      }

      #news-ticker {
        left: 0 !important;
        right: 0 !important;
        top: 0;
      }

      #om-stats {
        display: none;
        /* Hide on mobile to save space */
      }

      /* Mobile Menu Toggle */
      .mobile-menu-btn {
        display: flex !important;
        position: absolute;
        top: 55px;
        /* Below ticker */
        left: 16px;
        z-index: 1002;
        background: #0f1423;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        padding: 8px 12px;
        border-radius: 8px;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      }

      /* Popup Mobile */
      #custom-popup {
        width: 100%;
        top: 40%;
        /* Half screen */
        border-left: none;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        transform: translateY(100%);
      }

      #custom-popup.open {
        transform: translateY(0);
      }

      /* Inputs */
      .form-input,
      .form-textarea {
        font-size: 16px;
        /* Prevent IOS zoom */
      }
    }

    /* Mobile Toggle Button (Default Hidden) */
    .mobile-menu-btn {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <nav class="nav-bar">
    <img src="./yody-logo.png" alt="Yody" class="nav-logo">
    <div class="nav-items">
      <a class="nav-item active" href="javascript:void(0)" onclick="scrollToSection('home-section')">
        <span>üì∞</span> Trang ch·ªß
      </a>
      <a class="nav-item" href="javascript:void(0)" onclick="scrollToSection('map-section')">
        <span>üó∫Ô∏è</span> B·∫£n ƒë·ªì R·ªßi ro
      </a>
      <a class="nav-item" href="javascript:void(0)" onclick="scrollToSection('report-section')">
        <span>üì¢</span> T·ªë gi√°c ·∫©n danh
      </a>
      <a class="nav-item" href="javascript:void(0)" onclick="toggleTheme()" id="theme-toggle-btn"
        style="min-width: 100px;">
        <span>üåô</span> T·ªëi
      </a>
    </div>
  </nav>

  <!-- HOME SECTION -->
  <section id="home-section" class="view-container">
    <!-- Hero Section -->
    <div class="hero-section">
      <!-- <img src="./yody-logo.png" class="hero-logo"> -->
      <div class="hero-text">
        "T·∫°i YODY, ch√∫ng t√¥i hi·ªÉu r·∫±ng trong qu√° tr√¨nh l√†m vi·ªác, c√≥ th·ªÉ ph√°t sinh nh·ªØng ƒëi·ªÅu ch∆∞a ph√π h·ª£p v·ªõi gi√° tr·ªã
        c·ªët l√µi, quy chu·∫©n vƒÉn h√≥a ho·∫∑c c√°c h√†nh vi khi·∫øn b·∫°n bƒÉn khoƒÉn.
        <br><br>
        M·ªói g√≥p √Ω, m·ªói ph·∫£n √°nh t·ª´ b·∫°n kh√¥ng ch·ªâ gi√∫p ph√°t hi·ªán v√† ngƒÉn ch·∫∑n k·ªãp th·ªùi nh·ªØng sai l·ªách m√† c√≤n l√† ƒë·ªông l·ª±c
        m·∫°nh m·∫Ω ƒë·ªÉ YODY ng√†y c√†ng ho√†n thi·ªán h∆°n. ƒê√¢y l√† c√°ch ch√∫ng ta c√πng nhau x√¢y d·ª±ng m·ªôt m√¥i tr∆∞·ªùng l√†m vi·ªác minh
        b·∫°ch ‚Äì c√¥ng b·∫±ng ‚Äì nh√¢n vƒÉn, ƒë·ªìng th·ªùi ƒë√≥ng g√≥p th√™m nhi·ªÅu gi√° tr·ªã t√≠ch c·ª±c cho x√£ h·ªôi v√† c·ªông ƒë·ªìng.
        <br><br>
        üì© <strong>M·ªçi ph·∫£n √°nh ƒë·ªÅu ƒë∆∞·ª£c b·∫£o m·∫≠t tuy·ªát ƒë·ªëi, ti·∫øp nh·∫≠n v√† x·ª≠ l√Ω.</strong>"
      </div>
      <button class="hero-btn" onclick="scrollToSection('report-section')">T·ªê GI√ÅC NGAY</button>
    </div>

    <!-- News Grid -->
    <div class="wall-grid" id="wall-grid">
      <!-- Generated by JS -->
    </div>
  </section>

  <!-- MAP SECTION -->
  <section id="map-section" class="view-container">
    <div id="map-ui-container" style="position: relative; width: 100%; height: 100%;">

      <!-- News Ticker -->
      <div id="news-ticker">
        <div class="ticker-content" id="ticker-content">
          <span class="ticker-item">ƒêang t·∫£i tin t·ª©c...</span>
        </div>
      </div>

      <!-- Mobile Menu Button -->
      <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">
        ‚ò∞ Menu
      </button>

      <!-- OM Stats (Right) -->
      <div id="om-stats">
        <div class="om-title">Vi ph·∫°m theo OM</div>
        <div id="om-list">
          <!-- Items will be populated here -->
        </div>
      </div>

      <!-- Loading -->
      <div id="loading">
        <div class="spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>

      <!-- Login -->
      <div id="login-screen">
        <div class="login-box">
          <h2>üõ°Ô∏è ƒêƒÉng nh·∫≠p</h2>
          <p>H·ªá th·ªëng gi√°m s√°t r·ªßi ro n·ªôi b·ªô</p>
          <input type="email" class="login-input" id="email-input" placeholder="Email@yody.vn">
          <button class="login-btn" onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>
          <div class="login-error" id="login-error"></div>
        </div>
      </div>



      <!-- Sidebar -->
      <div class="sidebar">

        <!-- Header Moved Inside Sidebar -->
        <div class="header">
          <h1>Th∆∞ vi·ªán Qu·∫£n tr·ªã r·ªßi ro</h1>
          <div class="header-subtitle">H·ªá th·ªëng gi√°m s√°t v√† ph√¢n t√≠ch vi ph·∫°m to√†n di·ªán</div>
        </div>

        <div class="sidebar-search">
          <input type="text" class="search-input" id="store-search" placeholder="üîç T√¨m ki·∫øm c·ª≠a h√†ng..."
            oninput="handleSearch(this.value)">
          <div class="search-results" id="search-results"></div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Lo·∫°i hi·ªÉn th·ªã</div>
          <div class="filter-option active" onclick="setDisplayFilter('all')">
            <div class="filter-radio"></div>
            <div class="filter-label">T·∫•t c·∫£ c·ª≠a h√†ng</div>
          </div>
          <div class="filter-option" onclick="setDisplayFilter('violations')">
            <div class="filter-radio"></div>
            <div class="filter-label">C√≥ vi ph·∫°m</div>
          </div>
          <div class="filter-option" onclick="setDisplayFilter('clean')">
            <div class="filter-radio"></div>
            <div class="filter-label">Kh√¥ng vi ph·∫°m</div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Th·ªëng k√™ t·ªïng quan</div>
          <div class="stat-card">
            <div class="stat-icon stores">üè™</div>
            <div class="stat-content">
              <div class="stat-value" id="total-stores">0</div>
              <div class="stat-label">C·ª≠a h√†ng</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon violations">‚ö†Ô∏è</div>
            <div class="stat-content">
              <div class="stat-value" id="total-violations">0</div>
              <div class="stat-label">Vi ph·∫°m</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon rewards">üèÜ</div>
            <div class="stat-content">
              <div class="stat-value" id="total-rewards">0</div>
              <div class="stat-label">Khen th∆∞·ªüng</div>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Top 5 Vi ph·∫°m nhi·ªÅu nh·∫•t</div>
          <div id="top-violations" style="font-size: 12px;">
            <!-- Will be populated by JS -->
          </div>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Ch·ªâ ti√™u m·ª©c ƒë·ªô</div>
          <div class="risk-gradient"></div>
          <div class="risk-labels">
            <span>0 vi ph·∫°m</span>
            <span>1-2</span>
            <span>3-4</span>
            <span>5+</span>
          </div>
        </div>


      </div>

      <!-- Map -->
      <div id="map"></div>

      <!-- Custom Popup (Note: Moved here to be inside relative container) -->
      <div class="popup-overlay" id="popup-overlay" onclick="closePopup()"></div>
      <div id="custom-popup">
        <div id="popup-views">
          <!-- List View -->
          <div id="view-list" class="view-section">
            <div class="popup-header">
              <button class="popup-close" onclick="closePopup()">‚úï</button>
              <h3 id="popup-store-name"></h3>
              <div class="address" id="popup-store-address"></div>
            </div>
            <div class="popup-tabs">
              <div class="popup-tab violations active" onclick="switchTab('violations')">
                ‚ö†Ô∏è Vi ph·∫°m (<span id="tab-violations-count">0</span>)
              </div>
              <div class="popup-tab rewards" onclick="switchTab('rewards')">
                üèÜ Khen th∆∞·ªüng (<span id="tab-rewards-count">0</span>)
              </div>
            </div>
            <div class="popup-body" id="popup-body"></div>
          </div>
          <!-- Detail View -->
          <div id="view-detail" class="view-section">
            <div class="popup-header">
              <button class="popup-close" onclick="closePopup()">‚úï</button>
              <button class="back-btn" onclick="backToList()">‚Üê Quay l·∫°i</button>
              <h3 id="detail-header-title">Chi ti·∫øt vi ph·∫°m</h3>
            </div>
            <div class="detail-body" id="detail-body"></div>
          </div>
        </div>
      </div>
    </div> <!-- End Map UI Container -->
  </section>

  <script>
    // Config
    const SHEET_ID = '1wwjXmvOrNn4G7uNdAGPwwa2RpTvfYrRASzAD5PNpbEE';
    const MAIL_SHEET_ID = '1Eea0RMfjsrv_JrCadKxdVWvYdsm14riZYtNcuUWOii0';
    const CSV_STORES = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
    const CSV_EVENTS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=484651391`;
    const CSV_HIGHLIGHTS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=1234567890`; // Update if highlights exist
    const CSV_MAIL = `https://docs.google.com/spreadsheets/d/${MAIL_SHEET_ID}/export?format=csv&gid=291208241`;

    // UI Config
    const ZOOM_THRESHOLD = 10; // Zoom level to show store names (Higher = Closer)

    let map, STORES_DATA = [], EVENTS_DATA = [], HIGHLIGHTS_DATA = [], markers = [];
    let currentTimeFilter = 'all', currentDisplayFilter = 'all';
    let searchTimeout;

    // Session Check
    window.onload = () => {
      const email = localStorage.getItem('yody_user');
      if (email) {
        initDashboard();
      } else {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
      }
    };

    async function handleLogin() {
      const email = document.getElementById('email-input').value.trim().toLowerCase();
      const error = document.getElementById('login-error');

      if (!email.endsWith('@yody.vn')) {
        error.textContent = 'Ch·ªâ ch·∫•p nh·∫≠n email @yody.vn';
        error.style.display = 'block';
        return;
      }

      try {
        const whitelist = await fetchCSV(CSV_MAIL);
        const isAuthorized = whitelist.some(row =>
          Object.values(row).some(val => val.toString().toLowerCase().trim() === email)
        );

        if (isAuthorized) {
          localStorage.setItem('yody_user', email);
          location.reload();
        } else {
          error.textContent = 'Email kh√¥ng c√≥ quy·ªÅn truy c·∫≠p';
          error.style.display = 'block';
        }
      } catch (e) {
        error.textContent = 'L·ªói k·∫øt n·ªëi';
        error.style.display = 'block';
      }
    }

    async function initDashboard() {
      if (document.getElementById('login-screen')) document.getElementById('login-screen').style.display = 'none';
      if (document.getElementById('loading')) document.getElementById('loading').style.display = 'flex';

      // Init Map
      try {
        map = L.map('map', { zoomControl: false }).setView([16.0, 107.5], 6);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);
      } catch (mapErr) {
        console.error("Map initialization failed:", mapErr);
      }

      // Load Vietnam Border
      try {
        const response = await fetch('https://cdn.jsdelivr.net/gh/Vizzuality/growasia_calculator@master/public/vietnam.geojson');
        const vnGeoJSON = await response.json();
        L.geoJSON(vnGeoJSON, {
          style: { color: '#00ff88', weight: 2, fillOpacity: 0, opacity: 0.8 }
        }).addTo(map);
      } catch (e) {
        console.warn("Vietnam border fetch failed (non-critical).");
      }

      // Sovereignty: Hoang Sa & Truong Sa

      // PATCH: Cover "Bi·ªÉn ƒê√¥ng" / "South China Sea" label
      const patchIcon = L.divIcon({
        className: 'map-patch',
        html: '<div style="background: #212121; width: 300px; height: 100px; transform: rotate(-25deg); filter: blur(15px); opacity: 0.9;"></div>',
        iconSize: [300, 100],
        iconAnchor: [150, 50]
      });
      L.marker([14.5, 114.0], { icon: patchIcon, interactive: false, zIndexOffset: -100 }).addTo(map);

      const islands = [
        { name: "Qu·∫ßn ƒë·∫£o Ho√†ng Sa", coords: [16.4, 112.0] },
        { name: "Qu·∫ßn ƒë·∫£o Tr∆∞·ªùng Sa", coords: [10.0, 114.0] }
      ];

      islands.forEach(island => {
        L.marker(island.coords, {
          icon: L.divIcon({
            className: 'map-label',
            html: island.name,
            iconSize: [200, 20],
            iconAnchor: [100, 10]
          }),
          interactive: false
        }).addTo(map);
      });

      // Zoom Listeners (Store Names)
      map.on('zoomend', () => {
        const zoom = map.getZoom();
        if (zoom >= ZOOM_THRESHOLD) {
          document.getElementById('map').classList.add('show-names');
        } else {
          document.getElementById('map').classList.remove('show-names');
        }
      });

      // Load Data
      try {
        await loadData();
      } catch (err) {
        console.error("Dashboard data load failed:", err);
      } finally {
        if (document.getElementById('loading')) {
          document.getElementById('loading').style.display = 'none';
        }
      }
    }

    async function loadData() {
      try {
        // Load all data
        const rawStores = await fetchCSV(CSV_STORES);
        const rawEvents = await fetchCSV(CSV_EVENTS, false); // No header parsing for safer mapping

        // Process Stores (Standard Header)
        STORES_DATA = rawStores.filter(s => s.ID && s.ID.toString().trim());

        // Process Events (Manual Mapping)
        // Filter valid rows: Must have enough columns and look like an event (start with EV or have a date)
        // User confirmed: Col B (Index 1) is Store ID.
        // Assuming format: [EventID, StoreID, Date, Type, Description]
        const validEventRows = rawEvents.data.filter(row => {
          return row.length >= 3 && (row[0] || '').toString().toUpperCase().startsWith('EV');
        });

        EVENTS_DATA = validEventRows.map(row => ({
          ID: row[0],
          Store_ID: row[1], // Column B
          Date: row[2],     // Column C
          Type: row[3],
          Description: row[4]
        }));

        // Try to load highlights, if fails just continue
        try {
          HIGHLIGHTS_DATA = await fetchCSV(CSV_HIGHLIGHTS);
        } catch (e) {
          HIGHLIGHTS_DATA = [];
        }

        console.log('=== LOADED ===');
        console.log('ZOOM THRESHOLD CONFIG:', ZOOM_THRESHOLD);
        console.log('Stores:', STORES_DATA.length);
        console.log('Events:', EVENTS_DATA.length);
        console.log('\n=== SAMPLES ===');
        console.log('Store[0]:', STORES_DATA[0]);
        console.log('Event[0]:', EVENTS_DATA[0]);

        // Process each store
        let debugCount = 0;

        STORES_DATA.forEach((store, storeIdx) => {
          const storeID = (store.ID || '').toString().trim();

          // Count violations - try multiple matching methods
          const violations = EVENTS_DATA.filter((event, eventIdx) => {
            const eventCols = Object.values(event);
            const eventKeys = Object.keys(event);

            // Try different ways to get Store_ID from event:
            // Method 1: By index (column B = index 1, but might be 0 if Event_ID is missing header)
            const storeID_idx0 = (eventCols[0] || '').toString().trim();
            const storeID_idx1 = (eventCols[1] || '').toString().trim();
            const storeID_idx2 = (eventCols[2] || '').toString().trim();

            // Method 2: By column name variations
            const storeID_byName = (
              event['Store_ID'] ||
              event['ID'] ||
              event['StoreID'] ||
              event['store_id'] ||
              event[eventKeys[1]] || // Use whatever the second column is named
              ''
            ).toString().trim();

            // Check all possible matches
            const match = storeID_idx0 === storeID ||
              storeID_idx1 === storeID ||
              storeID_idx2 === storeID ||
              storeID_byName === storeID;

            // Debug first 3 events for first 2 stores
            if (storeIdx < 2 && eventIdx < 3 && debugCount < 10) {
              console.log(`Store ${storeID} vs Event[${eventIdx}]:`, {
                eventKeys,
                eventCols,
                storeID_idx0,
                storeID_idx1,
                storeID_byName,
                match
              });
              debugCount++;
            }

            return match;
          });

          // Count highlights with same logic
          const highlights = HIGHLIGHTS_DATA.filter(highlight => {
            const highlightCols = Object.values(highlight);
            const highlightKeys = Object.keys(highlight);
            const storeID_idx1 = (highlightCols[1] || '').toString().trim();
            const storeID_byName = (
              highlight['Store_ID'] ||
              highlight[highlightKeys[1]] ||
              ''
            ).toString().trim();
            return storeID_idx1 === storeID || storeID_byName === storeID;
          });

          store.violationCount = violations.length;
          store.highlightCount = highlights.length;

          store.violations = violations;
          store.highlights = highlights;
        });

        const withViolations = STORES_DATA.filter(s => s.violationCount > 0).length;
        const totalViolations = STORES_DATA.reduce((sum, s) => sum + s.violationCount, 0);
        console.log('\n=== RESULTS ===');
        console.log('Stores with violations:', withViolations);
        console.log('Total violations:', totalViolations);

        updateStats();
        renderMarkers();
        renderOMStats();
        renderNewsTicker();
      } catch (e) {
        console.error('Data load error:', e);
        // alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Google Sheets.');
      }
    }

    function renderOMStats() {
      // Group violations by OM
      const omCounts = {};

      STORES_DATA.forEach(store => {
        if (store.violationCount > 0) {
          // Extract OM name from Address (Format: OM.Name)
          // Also handle potential raw format anomalies
          const address = store.Address || '';
          let omName = 'Kh√°c';

          if (address.includes('OM.')) {
            const parts = address.split('OM.');
            if (parts.length > 1) {
              omName = parts[1].split(',')[0].trim(); // Take name after OM. and before next comma
            }
          }

          if (omName) {
            omCounts[omName] = (omCounts[omName] || 0) + store.violationCount;
          }
        }
      });

      // Sort by count desc
      const sortedOMs = Object.entries(omCounts)
        .sort((a, b) => b[1] - a[1]);

      const container = document.getElementById('om-list');
      container.innerHTML = '';

      if (sortedOMs.length === 0) {
        container.innerHTML = '<div style="color:rgba(255,255,255,0.5); font-size:11px; text-align:center;">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
        return;
      }

      sortedOMs.forEach(([name, count]) => {
        container.innerHTML += `
          <div class="om-item">
            <span class="om-name">${name}</span>
            <span class="om-count">${count}</span>
          </div>
        `;
      });
    }

    function renderNewsTicker() {
      // Filter events that have dates
      const validEvents = EVENTS_DATA.filter(e => {
        const cols = Object.values(e);
        const dateStr = e['Date'] || cols[2];
        return dateStr && dateStr.trim().length > 0;
      });

      // Sort by Date Descending
      validEvents.sort((a, b) => {
        const colsA = Object.values(a);
        const colsB = Object.values(b);
        const dateA = new Date(a['Date'] || colsA[2]);
        const dateB = new Date(b['Date'] || colsB[2]);
        return dateB - dateA;
      });

      // Take top 5
      const topEvents = validEvents.slice(0, 5);
      const container = document.getElementById('ticker-content');

      if (topEvents.length === 0) {
        container.innerHTML = '<span class="ticker-item">Kh√¥ng c√≥ tin t·ª©c m·ªõi</span>';
        return;
      }

      container.innerHTML = topEvents.map(event => {
        const cols = Object.values(event);
        const date = event['Date'] || cols[2];
        const desc = event['Description'] || cols[4] || 'Vi ph·∫°m ch∆∞a x√°c ƒë·ªãnh';

        // Find Store Name
        // Find Store Name - Robust Mapping
        const storeID_ev = (event['Store_ID'] || cols[1] || '').toString().trim();

        const store = STORES_DATA.find(s => {
          const sID = (s.ID || Object.values(s)[0] || '').toString().trim();
          return sID === storeID_ev;
        });

        const storeName = store ? store.Store_Name : `Store #${storeID_ev}`;
        const storeID = store ? (store.ID || Object.values(store)[0]) : '';

        // Snippet
        let snippet = desc.split(' ').slice(0, 15).join(' ') + '...';

        return `
          <span class="ticker-item" onclick="zoomToStore('${storeID}')">
            <span class="date">[${date}]</span>
            <span class="highlight">${storeName}</span>: ${snippet}
          </span>
        `;
      }).join(' <span style="margin: 0 10px; color: rgba(255,255,255,0.2)">|</span> ');
    }

    function zoomToStore(storeId) {
      console.log('Zooming to store:', storeId);
      if (!storeId) return;
      const store = STORES_DATA.find(s => s.ID.toString().trim() === storeId.toString().trim());
      if (store) {
        let lat = parseFloat(store.Latitude || 0);
        let lng = parseFloat(store.Longitude || 0);
        if (lat && lng) {
          map.setView([lat, lng], 18);
          openStorePopup(store);
        } else {
          console.warn('Store has no coords:', store);
        }
      } else {
        console.warn('Store not found for ID:', storeId);
      }
    }

    function updateStats() {
      const totalStores = STORES_DATA.length;
      const totalViolations = STORES_DATA.reduce((sum, s) => sum + (s.violationCount || 0), 0);
      const totalHighlights = STORES_DATA.reduce((sum, s) => sum + (s.highlightCount || 0), 0);

      document.getElementById('total-stores').textContent = totalStores;
      document.getElementById('total-violations').textContent = totalViolations;
      document.getElementById('total-rewards').textContent = totalHighlights;

      // Update Top 5
      updateTopViolations();
    }

    function updateTopViolations() {
      const topStores = STORES_DATA
        .filter(s => s.violationCount > 0)
        .sort((a, b) => b.violationCount - a.violationCount)
        .slice(0, 5);

      const container = document.getElementById('top-violations');
      container.innerHTML = '';

      if (topStores.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-size: 11px;">Kh√¥ng c√≥ vi ph·∫°m</p>';
        return;
      }

      topStores.forEach((store, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
                    padding: 10px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.08);
                    border-radius: 8px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
        item.onmouseover = () => item.style.background = 'rgba(255,255,255,0.08)';
        item.onmouseout = () => item.style.background = 'rgba(255,255,255,0.03)';

        const rankColor = index === 0 ? '#f44336' : index === 1 ? '#ff9800' : index === 2 ? '#ffeb3b' : '#999';

        item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 24px; height: 24px; background: ${rankColor}; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; color: #000;">${index + 1}</div>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${store.Store_Name || 'C·ª≠a h√†ng'}</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.6);">${store.violationCount} vi ph·∫°m</div>
                        </div>
                    </div>
                `;

        // Click to zoom to marker
        // Click to zoom to marker & open details
        item.onclick = () => {
          const lat = parseFloat(store.Latitude || 0);
          const lng = parseFloat(store.Longitude || 0);
          if (lat && lng) {
            map.setView([lat, lng], 16);
            openStorePopup(store);
          }
        };

        container.appendChild(item);
      });
    }

    // Popup & Modal Functions
    let currentStore = null;

    function openStorePopup(store) {
      currentStore = store;
      document.getElementById('popup-store-name').textContent = store.Store_Name || 'C·ª≠a h√†ng';
      document.getElementById('popup-store-address').textContent = store.Address || '';
      document.getElementById('tab-violations-count').textContent = store.violationCount || 0;
      document.getElementById('tab-rewards-count').textContent = store.highlightCount || 0;

      // Sidebar logic: add .open class, ensure we start at list view
      const popup = document.getElementById('custom-popup');
      popup.classList.remove('show-detail'); // Reset to list view
      popup.classList.add('open');

      document.getElementById('popup-overlay').style.display = 'none';

      switchTab('violations');
    }

    function closePopup() {
      document.getElementById('custom-popup').classList.remove('open');
    }

    let currentTab = 'violations';

    function switchTab(tab) {
      currentTab = tab;

      // Update UI
      document.querySelectorAll('.popup-tab').forEach(el => el.classList.remove('active'));
      document.querySelector(`.popup-tab.${tab}`).classList.add('active');

      const body = document.getElementById('popup-body');
      body.innerHTML = '';

      const items = tab === 'violations' ? currentStore.violations : currentStore.highlights;

      if (!items || items.length === 0) {
        body.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
        return;
      }

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';

        // Use Description for Title (Snippet) if Violation Type is generic/missing
        const cols = Object.values(item);
        // Column mapping based on observation: 0:ID, 2:Date, 4:Desc
        let fullDesc = item['Description'] || cols[4] || '';

        // Fallback title logic
        let type = tab === 'violations' ? (item['Violation_Type'] || 'Vi ph·∫°m') : (item['Type'] || 'Khen th∆∞·ªüng');
        let date = item['Date'] || cols[2] || '';

        // Smart Title: First 10 words of description
        let shortTitle = fullDesc.split(' ').slice(0, 10).join(' ');
        if (fullDesc.length > shortTitle.length) shortTitle += '...';

        // If description is empty, fallback to type + ID
        if (!shortTitle.trim()) {
          shortTitle = `${type} #${item['ID'] || cols[0] || ''}`;
        }

        card.innerHTML = `
          <div class="item-title">
            <span>${shortTitle}</span>
          </div>
          <div class="item-preview" style="display:flex; justify-content:space-between; margin-top:4px;">
             <span>${date}</span>
             <span style="font-size:10px; opacity:0.7; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${type}</span>
          </div>
        `;

        card.onclick = () => showDetail(item);
        body.appendChild(card);
      });
    }

    function showDetail(item) {
      const body = document.getElementById('detail-body');
      body.innerHTML = '';

      // Auto-generate fields
      for (const [key, val] of Object.entries(item)) {
        if (!val || val.toString().trim() === '') continue;

        const field = document.createElement('div');
        field.className = 'field'; // Re-use existing class or new .detail-field
        field.innerHTML = `
          <div class="detail-label">${key.replace(/_/g, ' ')}</div>
          <div class="detail-value">${val}</div>
        `;
        body.appendChild(field); // Re-using .field CSS
      }

      // Slide to detail view
      document.getElementById('custom-popup').classList.add('show-detail');
    }

    function backToList() {
      document.getElementById('custom-popup').classList.remove('show-detail');
    }

    function renderMarkers() {
      // Clear existing
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      STORES_DATA.forEach(store => {
        // Filter logic
        if (currentDisplayFilter === 'violations' && (!store.violationCount || store.violationCount === 0)) return;
        if (currentDisplayFilter === 'clean' && store.violationCount && store.violationCount > 0) return;

        // Get coordinates - use exact column names
        let lat = parseFloat(store.Latitude || 0);
        let lng = parseFloat(store.Longitude || 0);

        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
          console.warn('Invalid coords for store:', store.Store_Name, lat, lng);
          return;
        }

        const count = store.violationCount || 0;
        const markerColor = count === 0 ? 'marker-green' :
          count <= 2 ? 'marker-yellow' :
            count <= 4 ? 'marker-orange' : 'marker-red';

        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div class="marker-circle ${markerColor}">${count}</div>`,
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(map);

        // Bind Tooltip for Store Name (visible on zoom)
        marker.bindTooltip(store.Store_Name || 'C·ª≠a h√†ng', {
          permanent: true,
          direction: 'top',
          className: 'store-label-tooltip',
          offset: [0, -16]
        });

        // Use Custom Popup -> Sidebar
        marker.on('click', () => {
          openStorePopup(store);
          map.setView([lat, lng], 16); // High zoom
        });

        markers.push(marker);
      });

      console.log('Rendered markers (Custom Popup v2):', markers.length);
    }

    function setDisplayFilter(filter) {
      currentDisplayFilter = filter;
      document.querySelectorAll('.sidebar-section:nth-child(1) .filter-option').forEach((el, i) => {
        el.classList.toggle('active', ['all', 'violations', 'clean'][i] === filter);
      });
      renderMarkers();
    }

    function fetchCSV(url, header = true) {
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error("Fetch timeout for URL: " + url));
        }, 15000); // 15s timeout

        Papa.parse(url, {
          download: true,
          header: header,
          skipEmptyLines: true,
          complete: (results) => {
            clearTimeout(timeout);
            if (header) resolve(results.data);
            else resolve(results); // Return full result for manual handling
          },
          error: (err) => {
            clearTimeout(timeout);
            reject(err);
          }
        });
      });
    }
    // Search Functionality
    function handleSearch(query) {
      clearTimeout(searchTimeout);
      const resultsContainer = document.getElementById('search-results');

      if (!query || query.trim().length === 0) {
        resultsContainer.classList.remove('active');
        return;
      }

      searchTimeout = setTimeout(() => {
        const searchTerm = query.toLowerCase().trim();
        const matches = STORES_DATA.filter(store => {
          const name = (store.Store_Name || '').toLowerCase();
          const address = (store.Address || '').toLowerCase();
          return name.includes(searchTerm) || address.includes(searchTerm);
        }).slice(0, 10); // Limit to 10 results

        if (matches.length > 0) {
          resultsContainer.innerHTML = matches.map(store => `
            <div class="search-item" onclick="selectSearchStore('${store.ID}')">
              <div>${store.Store_Name}</div>
              <div class="sub-text">${store.Address || 'Kh√¥ng c√≥ ƒë·ªãa ch·ªâ'}</div>
            </div>
          `).join('');
          resultsContainer.classList.add('active');
        } else {
          resultsContainer.innerHTML = `
            <div class="search-item" style="cursor: default; opacity: 0.5;">
              Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£
            </div>
          `;
          resultsContainer.classList.add('active');
        }
      }, 300);
    }

    function selectSearchStore(storeId) {
      const store = STORES_DATA.find(s => s.ID.toString() === storeId.toString());
      if (store) {
        // Zoom to store
        let lat = parseFloat(store.Latitude || 0);
        let lng = parseFloat(store.Longitude || 0);

        if (lat && lng) {
          map.setView([lat, lng], 18); // Zoom very close
          openStorePopup(store);

          // Clear search
          document.getElementById('store-search').value = '';
          document.getElementById('search-results').classList.remove('active');
        } else {
          alert('C·ª≠a h√†ng n√†y ch∆∞a c√≥ t·ªça ƒë·ªô tr√™n b·∫£n ƒë·ªì');
        }
      }
    }

    // Close search when clicking outside
    document.addEventListener('click', (e) => {
      const searchContainer = document.querySelector('.sidebar-search');
      if (searchContainer && !searchContainer.contains(e.target)) {
        const results = document.getElementById('search-results');
        if (results) results.classList.remove('active');
      }
    });


  </script>



  </section> <!-- End MAP SECTION -->

  <!-- REPORT SECTION -->
  <section id="report-section">
    <div class="report-box">
      <div class="report-title">G·ª≠i ph·∫£n √°nh ·∫©n danh</div>

      <!-- Embedded Google Form -->
      <iframe
        src="https://docs.google.com/forms/d/e/1FAIpQLScrXACk6KHdNz0kkWKy2FynUR2xz1GIRJdHdbgGhfPPkGYwig/viewform?embedded=true"
        width="100%" height="800" frameborder="0" marginheight="0" marginwidth="0"
        style="border-radius: 12px; background: transparent;">
        ƒêang t·∫£i form...
      </iframe>

      <!-- Note about integration -->
      <p style="text-align:center; font-size:11px; margin-top:20px; color:var(--text-muted);">
        * D·ªØ li·ªáu ƒë∆∞·ª£c b·∫£o m·∫≠t v√† g·ª≠i tr·ª±c ti·∫øp v·ªÅ Ban ki·ªÉm so√°t.
      </p>
    </div>
  </section>

  <!-- FOOTER -->
  <div class="footer">
    <h3 style="font-size: 18px; margin-bottom: 20px; color: var(--text-color);">TH√îNG TIN LI√äN H·ªÜ</h3>

    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">üìç</span>
        <span>ƒê·ªãa ch·ªâ: C√¥ng ty YODY, ƒë∆∞·ªùng An ƒê·ªãnh, ph∆∞·ªùng Vi·ªát H√≤a, th√†nh ph·ªë H·∫£i Ph√≤ng</span>
      </div>

      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">üìû</span>
        <span>Hotline: 0888 673 258</span>
      </div>

      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 18px;">‚úâÔ∏è</span>
        <span>Email: Anninhnoibo@yody.vn</span>
      </div>
    </div>

    <p style="font-style: italic; color: var(--text-muted); font-size: 13px;">
      T√†i li·ªáu n·ªôi b·ªô c·ªßa Yody. Nghi√™m c·∫•m h√†nh vi sao ch√©p, chia s·∫ª, ph√°t t√°n d∆∞·ªõi m·ªçi h√¨nh th·ª©c.
    </p>
  </div>

  <script>
    // --- PORTAL JS ---
    // --- PORTAL JS ---
    const CSV_HOME = 'https://docs.google.com/spreadsheets/d/1wwjXmvOrNn4G7uNdAGPwwa2RpTvfYrRASzAD5PNpbEE/export?format=csv&gid=165883319';
    let HOME_DATA = [];

    function scrollToSection(sectionId) {
      const section = document.getElementById(sectionId);
      if (section) {
        // Adjust for fixed nav height (60px)
        const y = section.getBoundingClientRect().top + window.pageYOffset - 60;
        window.scrollTo({ top: y, behavior: 'smooth' });

        // Update active nav manually (though scroll listener handles it too)
        // document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      }
    }

    // Load Home Data
    async function loadHomeData() {
      try {
        const rawData = await fetchCSV(CSV_HOME, false);
        // Cols: A=Cat, B=Title, C=Excerpt, D=Detail, E=Image
        const rows = rawData.data || rawData;

        // Filter valid rows (must have title)
        // Filter valid rows (Skip header row 0, then check for data)
        const validRows = rows.slice(1).filter(r => r.length > 1 && r[1] && r[1].trim() !== '');

        HOME_DATA = validRows.map(r => ({
          category: r[0],
          title: r[1],
          excerpt: r[2],
          detail: r[3],
          image: r[4]
        }));

        renderHomeGrid();
      } catch (e) {
        console.error("Error loading home data", e);
        document.getElementById('wall-grid').innerHTML = '<div style="color:white; text-align:center;">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i vi·∫øt.</div>';
      }
    }

    function renderHomeGrid() {
      const grid = document.getElementById('wall-grid');
      grid.innerHTML = HOME_DATA.map((story, index) => {
        let cleanImage = story.image || 'https://via.placeholder.com/300';

        // Handle Google Redirect URLs
        if (cleanImage.includes('google.com/url') && cleanImage.includes('url=')) {
          try {
            const urlParam = new URL(cleanImage).searchParams.get('url');
            if (urlParam) cleanImage = decodeURIComponent(urlParam);
          } catch (e) { }
        }

        // Handle Google Drive Links (Convert /view to direct link)
        const driveRegex = /\/d\/([a-zA-Z0-9_-]+)/;
        const driveMatch = cleanImage.match(driveRegex);
        if (driveMatch && driveMatch[1]) {
          // Convert to direct source URL
          cleanImage = `https://drive.google.com/uc?export=view&id=${driveMatch[1]}`;
        }

        return `
            <div class="news-card" onclick="showNewsDetail(${index})">
                <img src="${cleanImage}" class="news-img" onerror="this.src='https://via.placeholder.com/300'">
                <div class="news-content">
                    <span class="news-tag">${story.category || 'Tin t·ª©c'}</span>
                    <div class="news-title">${story.title}</div>
                    <div class="news-excerpt">${story.excerpt || ''}</div>
                    <div class="news-footer">
                        <span>Chi ti·∫øt &rarr;</span>
                    </div>
                </div>
            </div>
        `;
      }).join('');
    }

    function showNewsDetail(index) {
      const story = HOME_DATA[index];
      if (!story) return;

      // Extract image again for modal
      let url = story.image || '';

      // Handle Redirects
      if (url.includes('google.com/url') && url.includes('url=')) {
        try {
          url = decodeURIComponent(new URL(url).searchParams.get('url'));
        } catch (e) { }
      }

      // Check content type
      let contentHtml = '';
      const driveRegex = /\/d\/([a-zA-Z0-9_-]+)/;
      const driveMatch = url.match(driveRegex);

      if (driveMatch && driveMatch[1]) {
        // DRIVE LINK: Use Iframe Preview
        const previewUrl = `https://drive.google.com/file/d/${driveMatch[1]}/preview`;
        contentHtml = `<iframe src="${previewUrl}" width="100%" height="450px" style="border:none; border-radius:12px; background:#000;"></iframe>`;
      } else if (url && !url.includes('placeholder')) {
        // STANDARD IMAGE
        contentHtml = `<img src="${url}" style="width:100%; height:auto; border-radius:12px; margin-bottom:10px;">`;
      }

      // Populate Global Modal
      const modal = document.getElementById('global-news-modal');
      const body = document.getElementById('global-news-body');

      body.innerHTML = `
        <div style="margin-bottom:20px;">${contentHtml}</div>
        <h2 style="font-size:24px; color:var(--text-color); margin-bottom:12px; line-height:1.4;">${story.title}</h2>
        <div style="font-size:13px; color:var(--text-muted); margin-bottom:20px; text-transform:uppercase; letter-spacing:1px;">${story.category || 'Tin t·ª©c'}</div>
        <div style="font-size:16px; color:var(--text-color); line-height:1.6; white-space:pre-wrap;">${story.detail || story.excerpt || 'Kh√¥ng c√≥ n·ªôi dung chi ti·∫øt.'}</div>
      `;

      modal.classList.add('active');
    }

    function closeNewsModal() {
      document.getElementById('global-news-modal').classList.remove('active');
      document.getElementById('global-news-body').innerHTML = '';
    }

    // Theme Logic with Auto-Detection
    const THEMES = [
      { id: 'dark', icon: 'üåô', name: 'T·ªëi' },
      { id: 'tet', icon: 'üßß', name: 'T·∫øt' },
      { id: 'spring', icon: 'üå∏', name: 'Xu√¢n' },
      { id: 'summer', icon: 'üåä', name: 'H·∫°' },
      { id: 'autumn', icon: 'üçÇ', name: 'Thu' },
      { id: 'winter', icon: '‚ùÑÔ∏è', name: 'ƒê√¥ng' }
    ];

    // Auto-detect seasonal theme based on date
    function getSeasonalTheme() {
      const now = new Date();
      const month = now.getMonth() + 1; // 1-12
      const day = now.getDate();

      // Vietnamese Lunar New Year (Tet) - approx late Jan to early Feb
      // 2026: Jan 29 - Feb 16 (approximate 15 day period)
      if ((month === 1 && day >= 20) || (month === 2 && day <= 16)) {
        return 'tet';
      }

      // Spring (Xu√¢n): Feb-April
      if (month >= 2 && month <= 4) {
        return 'spring';
      }

      // Summer (H·∫°): May-July
      if (month >= 5 && month <= 7) {
        return 'summer';
      }

      // Autumn (Thu): August-October
      if (month >= 8 && month <= 10) {
        return 'autumn';
      }

      // Winter (ƒê√¥ng): November-January
      if (month >= 11 || month === 1) {
        return 'winter';
      }

      return 'dark'; // Fallback
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || 'dark';
      const idx = THEMES.findIndex(t => t.id === current);
      const nextIdx = (idx + 1) % THEMES.length;
      const nextTheme = THEMES[nextIdx];

      document.documentElement.setAttribute('data-theme', nextTheme.id);
      localStorage.setItem('theme', nextTheme.id);

      const btn = document.getElementById('theme-toggle-btn');
      if (btn) btn.innerHTML = `<span>${nextTheme.icon}</span> ${nextTheme.name}`;
    }

    // Init Theme with Auto-Detection
    const manualTheme = localStorage.getItem('theme');
    const autoTheme = getSeasonalTheme();
    const initialTheme = manualTheme || autoTheme;

    if (initialTheme) {
      document.documentElement.setAttribute('data-theme', initialTheme);
      const themeObj = THEMES.find(t => t.id === initialTheme);
      setTimeout(() => {
        const btn = document.getElementById('theme-toggle-btn');
        if (btn && themeObj) {
          btn.innerHTML = `<span>${themeObj.icon}</span> ${themeObj.name}`;
          // Show auto-detected indicator if no manual selection
          if (!manualTheme) {
            btn.title = `Auto: ${themeObj.name}`;
          }
        }
      }, 100);
    }



    function handleSubmitReport(event) {
      event.preventDefault();
      const btn = event.target.querySelector('button');
      const originalText = btn.innerText;
      btn.innerText = 'ƒêang g·ª≠i...';
      btn.disabled = true;

      setTimeout(() => {
        alert('C·∫£m ∆°n b·∫°n! B√°o c√°o c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i ·∫©n danh th√†nh c√¥ng. (M√¥ ph·ªèng)');
        event.target.reset();
        btn.innerText = originalText;
        btn.disabled = false;
      }, 1500);
    }

    // Call Load Logic
    loadHomeData();

    // Auto-scroll update on scroll
    window.addEventListener('scroll', () => {
      const scrollPos = window.scrollY + 100;
      const sections = ['home-section', 'map-section', 'report-section'];
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));

      for (let i = 0; i < sections.length; i++) {
        const sec = document.getElementById(sections[i]);
        if (sec && sec.offsetTop <= scrollPos && (sec.offsetTop + sec.offsetHeight) > scrollPos) {
          const items = document.querySelectorAll('.nav-item');
          if (items[i]) items[i].classList.add('active');
          break;
        }
      }
    });

    // Mobile Sidebar Toggle
    function toggleMobileSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
    }

  </script>
  <!-- GLOBAL NEWS MODAL -->
  <div id="global-news-modal" style="
      position: fixed; inset: 0; z-index: 20000;
      background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
      display: none; align-items: center; justify-content: center;
      padding: 20px; opacity: 0; transition: opacity 0.3s;
  " class="news-modal-container">
    <div style="
          width: 100%; max-width: 800px; max-height: 90vh;
          background: var(--popup-bg); border: 1px solid var(--border-color);
          border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
          box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      ">
      <div style="
              padding: 20px 24px; border-bottom: 1px solid var(--border-color);
              display: flex; justify-content: space-between; align-items: center;
              background: var(--header-bg);
          ">
        <h3 style="font-size: 18px; margin: 0; color: var(--text-color);">Chi ti·∫øt tin t·ª©c</h3>
        <button onclick="closeNewsModal()" style="
                  background: none; border: none; font-size: 24px;
                  color: var(--text-color); cursor: pointer; opacity: 0.7;
              ">‚úï</button>
      </div>
      <div id="global-news-body" style="
              padding: 24px; overflow-y: auto; color: var(--text-color);
          "></div>
    </div>
  </div>
  <style>
    #global-news-modal.active {
      display: flex !important;
      opacity: 1 !important;
    }
  </style>
</body>

</html>