<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th∆∞ vi·ªán Qu·∫£n tr·ªã R·ªßi ro</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse for CSV -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #0a0e27;
      color: #fff;
      overflow: hidden;
      height: 100vh;
    }

    /* Header */
    .header {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }

    .header-subtitle {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: -2px;
    }

    /* Sidebar */
    .sidebar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 280px;
      background: #151937;
      z-index: 999;
      overflow-y: auto;
      padding: 20px;
      padding-top: 80px;
    }

    .sidebar-section {
      margin-bottom: 28px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    .filter-option {
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-option:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(102, 126, 234, 0.5);
    }

    .filter-option.active {
      background: rgba(102, 126, 234, 0.15);
      border-color: #667eea;
    }

    .filter-radio {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      position: relative;
    }

    .filter-option.active .filter-radio::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: #667eea;
      border-radius: 50%;
    }

    .filter-label {
      font-size: 13px;
      font-weight: 500;
    }

    /* Stats Cards */
    .stat-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .stat-icon.stores {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-icon.violations {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-icon.rewards {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-content {
      flex: 1;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      text-transform: uppercase;
    }

    /* Risk Gradient */
    .risk-gradient {
      height: 8px;
      background: linear-gradient(90deg, #00ff88 0%, #ffeb3b 25%, #ff9800 50%, #f44336 100%);
      border-radius: 4px;
      margin-top: 8px;
    }

    .risk-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
    }

    /* Map */
    #map {
      position: absolute;
      left: 280px;
      top: 0;
      right: 0;
      bottom: 0;
      background: #0a0e27;
    }

    .leaflet-container {
      background: #0a0e27 !important;
    }

    /* Numbered Markers */
    .marker-circle {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 3px solid #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
      color: #000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .marker-green {
      background: #00ff88;
    }

    .marker-yellow {
      background: #ffeb3b;
    }

    .marker-orange {
      background: #ff9800;
    }

    .marker-red {
      background: #f44336;
      color: #fff;
    }

    /* Loading */
    #loading {
      position: fixed;
      inset: 0;
      background: #0a0e27;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(102, 126, 234, 0.2);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      100% {
        transform: rotate(360deg);
      }
    }

    /* Login Screen */
    #login-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .login-box {
      background: #fff;
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .login-box h2 {
      color: #667eea;
      margin-bottom: 8px;
      font-size: 24px;
    }

    .login-box p {
      color: #666;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .login-input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 16px;
      outline: none;
      transition: border-color 0.2s;
    }

    .login-input:focus {
      border-color: #667eea;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .login-error {
      color: #f44336;
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }
  </style>
</head>

<body>

  <!-- Loading -->
  <div id="loading">
    <div class="spinner"></div>
    <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
  </div>

  <!-- Login -->
  <div id="login-screen">
    <div class="login-box">
      <h2>üõ°Ô∏è ƒêƒÉng nh·∫≠p</h2>
      <p>H·ªá th·ªëng gi√°m s√°t r·ªßi ro n·ªôi b·ªô</p>
      <input type="email" class="login-input" id="email-input" placeholder="Email@yody.vn">
      <button class="login-btn" onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>
      <div class="login-error" id="login-error"></div>
    </div>
  </div>

  <!-- Header -->
  <div class="header">
    <div class="header-icon">Y</div>
    <div>
      <h1>Th∆∞ vi·ªán Qu·∫£n tr·ªã R·ªßi ro</h1>
      <div class="header-subtitle">H·ªá th·ªëng gi√°m s√°t v√† ph√¢n t√≠ch vi ph·∫°m to√†n di·ªán</div>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Lo·∫°i hi·ªÉn th·ªã</div>
      <div class="filter-option active" onclick="setDisplayFilter('all')">
        <div class="filter-radio"></div>
        <div class="filter-label">T·∫•t c·∫£ c·ª≠a h√†ng</div>
      </div>
      <div class="filter-option" onclick="setDisplayFilter('violations')">
        <div class="filter-radio"></div>
        <div class="filter-label">C√≥ vi ph·∫°m</div>
      </div>
      <div class="filter-option" onclick="setDisplayFilter('clean')">
        <div class="filter-radio"></div>
        <div class="filter-label">Kh√¥ng vi ph·∫°m</div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Th·ªëng k√™ t·ªïng quan</div>
      <div class="stat-card">
        <div class="stat-icon stores">üè™</div>
        <div class="stat-content">
          <div class="stat-value" id="total-stores">0</div>
          <div class="stat-label">C·ª≠a h√†ng</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon violations">‚ö†Ô∏è</div>
        <div class="stat-content">
          <div class="stat-value" id="total-violations">0</div>
          <div class="stat-label">Vi ph·∫°m</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon rewards">üèÜ</div>
        <div class="stat-content">
          <div class="stat-value" id="total-rewards">0</div>
          <div class="stat-label">Khen th∆∞·ªüng</div>
        </div>
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Top 5 Vi ph·∫°m nhi·ªÅu nh·∫•t</div>
      <div id="top-violations" style="font-size: 12px;">
        <!-- Will be populated by JS -->
      </div>
    </div>

    <div class="sidebar-section">
      <div class="sidebar-title">Ch·ªâ ti√™u m·ª©c ƒë·ªô</div>
      <div class="risk-gradient"></div>
      <div class="risk-labels">
        <span>0 vi ph·∫°m</span>
        <span>1-2</span>
        <span>3-4</span>
        <span>5+</span>
      </div>
    </div>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <script>
    // Config
    const SHEET_ID = '1wwjXmvOrNn4G7uNdAGPwwa2RpTvfYrRASzAD5PNpbEE';
    const MAIL_SHEET_ID = '1Eea0RMfjsrv_JrCadKxdVWvYdsm14riZYtNcuUWOii0';
    const CSV_STORES = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
    const CSV_EVENTS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=484651391`;
    const CSV_HIGHLIGHTS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=1234567890`; // Update with correct gid
    const CSV_MAIL = `https://docs.google.com/spreadsheets/d/${MAIL_SHEET_ID}/export?format=csv&gid=291208241`;

    let map, STORES_DATA = [], EVENTS_DATA = [], HIGHLIGHTS_DATA = [], markers = [];
    let currentTimeFilter = 'all', currentDisplayFilter = 'all';

    // Session Check
    window.onload = () => {
      const email = localStorage.getItem('yody_user');
      if (email) {
        initDashboard();
      } else {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('login-screen').style.display = 'flex';
      }
    };

    async function handleLogin() {
      const email = document.getElementById('email-input').value.trim().toLowerCase();
      const error = document.getElementById('login-error');

      if (!email.endsWith('@yody.vn')) {
        error.textContent = 'Ch·ªâ ch·∫•p nh·∫≠n email @yody.vn';
        error.style.display = 'block';
        return;
      }

      try {
        const whitelist = await fetchCSV(CSV_MAIL);
        const isAuthorized = whitelist.some(row =>
          Object.values(row).some(val => val.toString().toLowerCase().trim() === email)
        );

        if (isAuthorized) {
          localStorage.setItem('yody_user', email);
          location.reload();
        } else {
          error.textContent = 'Email kh√¥ng c√≥ quy·ªÅn truy c·∫≠p';
          error.style.display = 'block';
        }
      } catch (e) {
        error.textContent = 'L·ªói k·∫øt n·ªëi';
        error.style.display = 'block';
      }
    }

    async function initDashboard() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('loading').style.display = 'flex';

      // Init Map
      map = L.map('map', { zoomControl: false }).setView([16.0, 107.5], 6);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
      L.control.zoom({ position: 'bottomleft' }).addTo(map);

      // Load Vietnam Border
      try {
        const response = await fetch('https://cdn.jsdelivr.net/gh/Vizzuality/growasia_calculator@master/public/vietnam.geojson');
        const vnGeoJSON = await response.json();
        L.geoJSON(vnGeoJSON, {
          style: { color: '#00ff88', weight: 2, fillOpacity: 0, opacity: 0.8 }
        }).addTo(map);
      } catch (e) { }

      // Load Data
      await loadData();

      document.getElementById('loading').style.display = 'none';
    }

    async function loadData() {
      try {
        // Load all data
        let rawStores = await fetchCSV(CSV_STORES);
        let rawEvents = await fetchCSV(CSV_EVENTS);

        // Filter empty rows
        STORES_DATA = rawStores.filter(s => s.ID && s.ID.toString().trim());
        EVENTS_DATA = rawEvents.filter(e => {
          const cols = Object.values(e);
          return cols.length > 1 && (cols[0] || cols[1]);
        });

        // Try to load highlights, if fails just continue
        try {
          HIGHLIGHTS_DATA = await fetchCSV(CSV_HIGHLIGHTS);
        } catch (e) {
          HIGHLIGHTS_DATA = [];
        }

        console.log('=== LOADED ===');
        console.log('Stores:', STORES_DATA.length, '(raw:', rawStores.length, ')');
        console.log('Events:', EVENTS_DATA.length, '(raw:', rawEvents.length, ')');
        console.log('\n=== SAMPLES ===');
        console.log('Store[0]:', STORES_DATA[0]);
        console.log('Event[0]:', EVENTS_DATA[0]);
        console.log('Event[0] keys:', Object.keys(EVENTS_DATA[0] || {}));
        console.log('Event[0] values:', Object.values(EVENTS_DATA[0] || {}));

        // Process each store
        STORES_DATA.forEach(store => {
          const storeID = (store.ID || '').toString().trim();

          // Count violations: match Events where column 2 (after Event_ID) equals Store.ID
          // In CSV with headers, this would be the second column which might be named differently
          // Let's use Object.values to get the second value
          const violations = EVENTS_DATA.filter(event => {
            const eventCols = Object.values(event);
            const eventStoreID = (eventCols[1] || '').toString().trim(); // Column 2 (index 1)
            return eventStoreID === storeID;
          });

          // Count highlights
          const highlights = HIGHLIGHTS_DATA.filter(highlight => {
            const highlightCols = Object.values(highlight);
            const highlightStoreID = (highlightCols[1] || '').toString().trim();
            return highlightStoreID === storeID;
          });

          store.violationCount = violations.length;
          store.highlightCount = highlights.length;

          // Store the events for popup display
          store.violations = violations;
          store.highlights = highlights;
        });

        const withViolations = STORES_DATA.filter(s => s.violationCount > 0).length;
        const totalViolations = STORES_DATA.reduce((sum, s) => sum + s.violationCount, 0);
        console.log('\n=== RESULTS ===');
        console.log('Stores with violations:', withViolations);
        console.log('Total violations:', totalViolations);

        updateStats();
        renderMarkers();
      } catch (e) {
        console.error('Data load error:', e);
        alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p Google Sheets.');
      }
    }

    function updateStats() {
      const totalStores = STORES_DATA.length;
      const totalViolations = STORES_DATA.reduce((sum, s) => sum + (s.violationCount || 0), 0);
      const totalHighlights = STORES_DATA.reduce((sum, s) => sum + (s.highlightCount || 0), 0);

      document.getElementById('total-stores').textContent = totalStores;
      document.getElementById('total-violations').textContent = totalViolations;
      document.getElementById('total-rewards').textContent = totalHighlights;

      // Update Top 5
      updateTopViolations();
    }

    function updateTopViolations() {
      const topStores = STORES_DATA
        .filter(s => s.violationCount > 0)
        .sort((a, b) => b.violationCount - a.violationCount)
        .slice(0, 5);

      const container = document.getElementById('top-violations');
      container.innerHTML = '';

      if (topStores.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.5); font-size: 11px;">Kh√¥ng c√≥ vi ph·∫°m</p>';
        return;
      }

      topStores.forEach((store, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
                    padding: 10px;
                    background: rgba(255,255,255,0.03);
                    border: 1px solid rgba(255,255,255,0.08);
                    border-radius: 8px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
        item.onmouseover = () => item.style.background = 'rgba(255,255,255,0.08)';
        item.onmouseout = () => item.style.background = 'rgba(255,255,255,0.03)';

        const rankColor = index === 0 ? '#f44336' : index === 1 ? '#ff9800' : index === 2 ? '#ffeb3b' : '#999';

        item.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 24px; height: 24px; background: ${rankColor}; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 11px; color: #000;">${index + 1}</div>
                        <div style="flex: 1; overflow: hidden;">
                            <div style="font-weight: 600; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${store.Store_Name || 'C·ª≠a h√†ng'}</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.6);">${store.violationCount} vi ph·∫°m</div>
                        </div>
                    </div>
                `;

        // Click to zoom to marker
        item.onclick = () => {
          const lat = parseFloat(store.Latitude || 0);
          const lng = parseFloat(store.Longitude || 0);
          if (lat && lng) {
            map.setView([lat, lng], 12);
          }
        };

        container.appendChild(item);
      });
    }

    function renderMarkers() {
      // Clear existing
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      STORES_DATA.forEach(store => {
        // Filter logic
        if (currentDisplayFilter === 'violations' && (!store.violationCount || store.violationCount === 0)) return;
        if (currentDisplayFilter === 'clean' && store.violationCount && store.violationCount > 0) return;

        // Get coordinates - use exact column names
        let lat = parseFloat(store.Latitude || 0);
        let lng = parseFloat(store.Longitude || 0);

        if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
          console.warn('Invalid coords for store:', store.Store_Name, lat, lng);
          return;
        }

        const count = store.violationCount || 0;
        const markerColor = count === 0 ? 'marker-green' :
          count <= 2 ? 'marker-yellow' :
            count <= 4 ? 'marker-orange' : 'marker-red';

        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div class="marker-circle ${markerColor}">${count}</div>`,
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(map);

        // Build popup content
        let popupContent = `
                    <div style="min-width: 200px;">
                        <strong>${store.Store_Name || 'C·ª≠a h√†ng'}</strong><br>
                        <small style="color: #666;">${store.Address || ''}</small><br>
                        <div style="margin-top: 8px;">
                            <span style="color: #f44336;">‚ö†Ô∏è Vi ph·∫°m: ${count}</span><br>
                            <span style="color: #4caf50;">üèÜ Khen th∆∞·ªüng: ${store.highlightCount || 0}</span>
                        </div>
                `;

        if (store.violations && store.violations.length > 0) {
          popupContent += '<div style="margin-top: 8px; border-top: 1px solid #ddd; padding-top: 8px;">';
          popupContent += '<strong style="font-size: 11px;">Vi ph·∫°m g·∫ßn nh·∫•t:</strong><br>';
          store.violations.slice(0, 2).forEach(v => {
            const desc = Object.values(v)[4] || ''; // Description is column 5
            popupContent += `<small style="color: #666;">${desc.substring(0, 100)}...</small><br>`;
          });
          popupContent += '</div>';
        }

        popupContent += '</div>';

        marker.bindPopup(popupContent);
        markers.push(marker);
      });

      console.log('Rendered markers:', markers.length);
    }

    function setDisplayFilter(filter) {
      currentDisplayFilter = filter;
      document.querySelectorAll('.sidebar-section:nth-child(1) .filter-option').forEach((el, i) => {
        el.classList.toggle('active', ['all', 'violations', 'clean'][i] === filter);
      });
      renderMarkers();
    }

    function fetchCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
          error: (err) => reject(err)
        });
      });
    }
  </script>
</body>

</html>